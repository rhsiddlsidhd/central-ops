name: On Pull Request Claude Code Review



on:
  pull_request:
    types: [opened, synchronize]
    paths:
      # 1. 포함할 경로들
      - 'src/**'
      - 'next.config.ts'
      - 'tsconfig.json'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/**'

      # 2. 위 경로 중에서 제외할 경로들
      # 반드시 포함할 경로 뒤에 와야 합니다.
      - '!**/*.md'
      - '!src/**/*.test.ts'
      - '!src/**/*.test.tsx'
      - '!src/**/*.spec.ts'
      - '!src/**/*.spec.tsx'

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}



      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ steps.app-token.outputs.token }}

          prompt: |
            시니어 개발자로서 PR #${{ github.event.pull_request.number }}를 리뷰하고 한국어로 인라인 리뷰 코멘트를 남겨주세요.

            ## Preparation
            1. `GEMINI.md` 파일을 읽고 프로젝트 컨벤션과 아키텍처 규칙 파악
            2. `gh pr diff ${{ github.event.pull_request.number }}` - 변경사항 확인 (src/ 디렉토리 집중)
            3. 기존 인라인 리뷰 코멘트 확인:
               `gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments`
            4. 이미 지적된 내용은 다시 언급하지 않음

            ## In-Depth Analysis
            다음 기준으로 코드 변경사항 분석:

            - **Correctness**: 코드가 의도한 대로 동작하는가? 버그나 논리 오류는 없는가?
            - **Maintainability**: 가독성, 네이밍, 모듈화가 명확하며 미래에 수정하기 쉬운가?
            - **TypeScript**: `any` 지양, 타입 정의가 엄격한가?
            - **Error Handling**: try-catch, edge case(null/undefined/빈배열) 처리가 적절한가?
            - **Security**: XSS, SQL Injection, 민감정보 노출 등 보안 취약점은 없는가?
            - **Convention**: GEMINI.md 가이드(상태관리, API 규약, 에러 핸들링 등)를 준수하는가?
            - **Architecture**: 컴포넌트 크기, 비즈니스 로직과 UI 분리가 적절한가?
            - **Performance**: 불필요한 리렌더링이나 비효율적 연산은 없는가?
            - **Testability**: 테스트 커버리지가 충분한가? 추가 테스트 케이스를 제안할 수 있는가?

            ## Provide Feedback
            분석 결과를 GitHub Pull Request Review API를 사용하여 인라인 리뷰로 제출하세요.

            ### 리뷰 제출 방법
            `gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews` 에 POST 요청:

            ```bash
            gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews \
              --method POST \
              -f body="## Summary
            전반적인 코드 품질에 대한 총평 (2-3문장)

            ## Conclusion
            APPROVED 또는 REQUEST CHANGES 사유" \
              -f event="<APPROVE 또는 REQUEST_CHANGES>" \
              -f 'comments=[
                {
                  "path": "상대파일경로",
                  "line": 라인번호,
                  "body": "**[Critical/Improvement/Nitpick]** 이슈 제목\n\n문제점 설명\n\n현재 코드:\n```ts\n현재코드\n```\n\n권장 코드:\n```ts\n권장코드\n```\n\n개선 이유"
                }
              ]'
            ```

            ### 리뷰 이벤트 결정 기준
            - **APPROVE**: Critical 이슈가 없고 머지 가능한 경우
            - **REQUEST_CHANGES**: Critical 이슈(버그, 보안, Breaking Changes)가 있는 경우

            ### 인라인 코멘트 작성 규칙
            - `path`: diff에 나타나는 파일의 상대 경로 (예: `src/components/Button.tsx`)
            - `line`: diff 기준 라인 번호 (변경된 파일의 새 라인 번호)
            - 각 코멘트의 `body`에 심각도 태그 포함: `[Critical]`, `[Improvement]`, `[Nitpick]`
            - 지적사항이 없으면 `comments`를 빈 배열로, `event`를 `APPROVE`로 설정
            - 코멘트마다 문제점, 현재 코드, 권장 코드, 개선 이유를 포함

            ## Tone
            - 건설적이고 전문적이며 친근하게
            - 모든 변경 요청에 대해 "왜" 필요한지 설명
            - 추상적인 지적 금지, 구체적인 코드로 보여주기

          claude_args: '--allowed-tools "Read,Glob,Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh api:*)"'
