name: On Pull Request Claude Code Review

on:
  workflow_call:
    secrets:
      APP_ID:
        description: "GitHub App ID for creating installation access tokens"
        required: true
      APP_PRIVATE_KEY:
        description: "GitHub App Private Key for creating installation access tokens"
        required: true
      CLAUDE_CODE_OAUTH_TOKEN:
        description: "Claude Code OAuth Token for code review"
        required: true

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ steps.app-token.outputs.token }}

          prompt: |
            PR #${{ github.event.pull_request.number }}의 코드 변경사항을 리뷰하고 한국어로 인라인 코멘트를 남겨주세요.
            린터, 타입체커, 포매터가 잡는 문제는 무시하고, 사람만 판단할 수 있는 맥락적 이슈에만 집중하세요.

            ## 준비
            1. `gh pr diff ${{ github.event.pull_request.number }}` 로 변경사항 확인
            2. 변경된 파일의 원본을 Read 도구로 읽어 전체 맥락 파악
            3. `gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/comments` 로 기존 코멘트 확인 후, 이미 지적된 내용은 중복하지 않음

            ## 리뷰 범위 (이것만 본다)

            **1. 버그 / 논리 오류**
            - 조건문 실수, off-by-one, 경쟁 조건(race condition)
            - null/undefined 접근이 런타임에 터질 수 있는 경로
            - async/await 누락, Promise 미처리
            - 의도와 다르게 동작하는 코드

            **2. 보안 취약점**
            - 사용자 입력이 검증 없이 쿼리/명령/HTML에 삽입되는 경우
            - 민감 정보(API 키, 비밀번호)가 코드에 하드코딩된 경우
            - 인증/인가 검증 누락

            **3. 데이터 손실 위험**
            - 덮어쓰기, 잘못된 삭제, 트랜잭션 누락
            - 에러 발생 시 부분 실행 상태로 남는 로직

            **4. 실수로 남긴 코드**
            - console.log, print, debugger 등 디버그 코드가 남아있는 경우
            - 주석 처리된 코드 블록이 포함된 경우
            - .env, config 등 설정 파일의 의도치 않은 변경
            - TODO/FIXME 주석이 미해결 상태로 추가된 경우

            ## 리뷰 범위 밖 (이것은 무시한다)
            - 코드 스타일, 포매터가 처리할 수 있는 단순 포맷팅 (이미 린터가 잡음)
            - 타입 정의 (any 사용 등은 린터가 처리)
            - 테스트 커버리지 부족
            - 리팩토링 제안, 성능 최적화 제안
            - "더 나은 방법이 있다" 수준의 개선 제안

            ## 코멘트 작성 규칙
            - 확실한 문제만 지적한다. 추측이나 "~할 수도 있다" 수준이면 코멘트하지 않는다.
            - 코멘트 형식: `**[Bug/Security/Data Loss/Mistake]** 문제 설명 + 수정 제안 코드`

            ## 리뷰 제출
            - `gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews` 에 POST
            - event는 항상 `COMMENT` (APPROVE나 REQUEST_CHANGES 사용 금지)
            - 이슈 없으면 comments 빈 배열 + body에 "확인된 문제 없음"

          claude_args: '--allowed-tools "Read,Glob,LS,Grep,Bash(gh *)"'
